<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È≠îÊ≥ïÊ£ÆÊûóÊï∏Â≠∏Êé¢Èö™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Ê®ôÈ°åÂçÄÂüü */
        .game-title {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-title h1 {
            font-size: clamp(28px, 6vw, 48px);
            margin-bottom: 10px;
            animation: titleFloat 3s ease-in-out infinite;
        }

        .coin-tag {
            display: inline-block;
            background: #ffd700;
            color: #8b4513;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #daa520;
        }

        .coin-container {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        @keyframes titleFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* ÈóúÂç°Âú∞Âúñ */
        .level-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .level-card {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .level-card:hover::before {
            left: 100%;
        }

        .level-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .level-card h3 {
            font-size: clamp(20px, 4vw, 26px);
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .level-icon {
            font-size: clamp(40px, 8vw, 60px);
            text-align: center;
            margin-bottom: 15px;
        }

        .level-records {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            gap: 10px;
        }

        .record-item {
            text-align: center;
            flex: 1;
        }

        .record-item .label {
            font-size: clamp(12px, 2.5vw, 14px);
            color: #666;
            margin-bottom: 5px;
        }

        .stars {
            font-size: clamp(16px, 3.5vw, 20px);
            color: #ffd700;
        }

        /* Á∑¥ÁøíÂçÄÂüüÊ®£Âºè */
        .practice-section {
            margin-top: 50px;
            padding: 30px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(255, 154, 158, 0.4);
        }

        .practice-title {
            text-align: center;
            color: white;
            font-size: clamp(24px, 5vw, 32px);
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: practiceGlow 2s ease-in-out infinite alternate;
        }

        @keyframes practiceGlow {
            from {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 255, 255, 0.5);
            }

            to {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.8);
            }
        }

        .practice-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            justify-items: center;
        }

        .practice-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
            background-clip: padding-box;
            max-width: 400px;
        }

        .practice-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 204, 0, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .practice-card:hover::before {
            left: 100%;
        }

        .practice-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 154, 158, 0.5);
            border-color: #ffcc00;
        }

        .practice-card h3 {
            font-size: clamp(22px, 4vw, 28px);
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .practice-icon {
            font-size: clamp(50px, 10vw, 70px);
            text-align: center;
            margin-bottom: 20px;
            animation: practiceFloat 3s ease-in-out infinite;
        }

        @keyframes practiceFloat {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-8px) rotate(5deg);
            }
        }

        .practice-description {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
            margin-top: 15px;
        }

        /* Èõ£Â∫¶ÈÅ∏ÊìáÂΩàÁ™ó */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 25px;
            font-size: clamp(22px, 5vw, 28px);
        }

        .difficulty-buttons {
            display: flex;
            gap: 15px;
            flex-direction: column;
        }

        .difficulty-btn {
            padding: 20px;
            font-size: clamp(18px, 4vw, 22px);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn.easy {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2c5f2d;
        }

        .difficulty-btn.hard {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #8b2500;
        }

        .difficulty-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .close-modal {
            background: #ccc;
            color: #333;
            margin-top: 15px;
            padding: 12px;
            font-size: clamp(16px, 3.5vw, 18px);
        }

        /* ÈÅäÊà≤Áï´Èù¢ */
        .game-screen {
            display: none;
            background: white;
            border-radius: 25px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .game-screen.active {
            display: block;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .info-item {
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            color: #667eea;
        }

        .back-btn {
            padding: 12px 24px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .question-area {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .question-text {
            font-size: clamp(18px, 4vw, 24px);
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* ÊôÇÈêòÈ°ØÁ§∫ */
        .clock-canvas {
            width: clamp(150px, 40vw, 250px);
            height: clamp(150px, 40vw, 250px);
            border: 8px solid #333;
            border-radius: 50%;
            position: relative;
            background: white;
            margin: 20px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .clock-center {
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            background: #333;
        }

        .hour-hand {
            width: 6px;
            height: 25%;
            background: #333;
            margin-left: -3px;
        }

        .minute-hand {
            width: 4px;
            height: 35%;
            background: #666;
            margin-left: -2px;
        }

        .clock-number {
            position: absolute;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            color: #333;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            margin-top: -10px;
            margin-left: -10px;
            z-index: 5;
        }

        .clock-tick {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            background: #333;
            transform-origin: 50% 50%;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .answer-btn {
            padding: 20px;
            font-size: clamp(16px, 3.5vw, 20px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            min-height: 60px;
        }

        .answer-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .answer-btn:active {
            transform: translateY(0);
        }

        .answer-btn.correct {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            animation: correctPulse 0.5s ease;
        }

        .answer-btn.wrong {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            animation: wrongShake 0.5s ease;
        }

        @keyframes correctPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes wrongShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
            transition: width 0.3s ease;
        }

        /* ÁµêÊûúÁï´Èù¢ */
        .result-screen {
            display: none;
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .result-screen.active {
            display: block;
            animation: modalSlideIn 0.5s ease;
        }

        .result-screen h2 {
            font-size: clamp(28px, 6vw, 36px);
            color: #667eea;
            margin-bottom: 20px;
        }

        .result-stars {
            font-size: clamp(40px, 10vw, 60px);
            margin: 20px 0;
        }

        .result-message {
            font-size: clamp(18px, 4vw, 22px);
            color: #666;
            margin-bottom: 30px;
        }

        .result-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .result-btn {
            padding: 15px 30px;
            font-size: clamp(16px, 3.5vw, 18px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .retry-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .home-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .result-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .level-map {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .game-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .answers-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .difficulty-buttons {
                gap: 12px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .level-map {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Ëß∏ÊéßÂÑ™Âåñ */
        @media (hover: none) and (pointer: coarse) {

            .answer-btn,
            .difficulty-btn,
            .result-btn,
            .back-btn {
                min-height: 50px;
                padding: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ÈÅäÊà≤Ê®ôÈ°å -->
        <div class="game-title">
            <h1>üå≥ È≠îÊ≥ïÊ£ÆÊûóÊï∏Â≠∏Êé¢Èö™ üå≥</h1>
            <p>ÈÅ∏ÊìáÈóúÂç°ÈñãÂßãÂÜíÈö™ÂêßÔºÅ</p>
        </div>

        <!-- ÈóúÂç°Âú∞Âúñ -->
        <div id="levelMap" class="level-map"></div>

        <!-- Á∑¥ÁøíÂçÄÂüü -->
        <div class="practice-section">
            <h2 class="practice-title">üî• ÁâπÂà•Á∑¥ÁøíÂçÄ üî•</h2>
            <div id="practiceMap" class="practice-map"></div>
        </div>

        <!-- Èõ£Â∫¶ÈÅ∏ÊìáÂΩàÁ™ó -->
        <div id="difficultyModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">ÈÅ∏ÊìáÈõ£Â∫¶</h2>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn easy" onclick="startGame('easy')">
                        üå± Á∞°ÂñÆÊ®°Âºè
                    </button>
                    <button class="difficulty-btn hard" onclick="startGame('hard')">
                        üî• Âõ∞Èõ£Ê®°Âºè
                    </button>
                    <button class="difficulty-btn close-modal" onclick="closeModal()">
                        ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>

        <!-- ÈÅäÊà≤Áï´Èù¢ -->
        <div id="gameScreen" class="game-screen">
            <div class="game-header">
                <div class="game-info">
                    <div class="info-item">
                        <span id="levelName">ÈóúÂç°ÂêçÁ®±</span>
                    </div>
                    <div class="info-item">
                        È°åÁõÆ: <span id="questionNumber">1</span>/<span id="totalQuestions">10</span>
                    </div>
                    <div class="info-item">
                        ÈåØË™§: <span id="errorCount">0</span>/3
                    </div>
                </div>
                <button class="back-btn" onclick="exitGame()">ËøîÂõûÂú∞Âúñ</button>
            </div>

            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="question-area">
                <div id="questionContent" class="question-text"></div>
                <div id="clockContainer"></div>
            </div>

            <div id="answersContainer" class="answers-grid"></div>
        </div>

        <!-- ÁµêÊûúÁï´Èù¢ -->
        <div id="resultScreen" class="result-screen">
            <h2 id="resultTitle">ÊÅ≠ÂñúÂÆåÊàêÔºÅ</h2>
            <div id="resultStars" class="result-stars"></div>
            <div id="resultMessage" class="result-message"></div>
            <div class="result-buttons">
                <button class="result-btn retry-btn" onclick="retryLevel()">ÂÜçÁé©‰∏ÄÊ¨°</button>
                <button class="result-btn home-btn" onclick="backToMap()">ËøîÂõûÂú∞Âúñ</button>
            </div>
        </div>
    </div>

    <script>
        const AudioSystem = {
            context: null,
            init() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
            },
            playCorrect() {
                if (!this.context) this.init();
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                oscillator.frequency.setValueAtTime(523.25, this.context.currentTime);
                oscillator.frequency.setValueAtTime(659.25, this.context.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(783.99, this.context.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.3);
            },
            playWrong() {
                if (!this.context) this.init();
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                oscillator.frequency.setValueAtTime(200, this.context.currentTime);
                oscillator.type = 'sawtooth';
                gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.2);
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.2);
            },
            playComplete() {
                if (!this.context) this.init();
                const notes = [523.25, 587.33, 659.25, 783.99];
                notes.forEach((freq, i) => {
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    oscillator.frequency.setValueAtTime(freq, this.context.currentTime + i * 0.15);
                    gainNode.gain.setValueAtTime(0.2, this.context.currentTime + i * 0.15);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + i * 0.15 + 0.3);
                    oscillator.start(this.context.currentTime + i * 0.15);
                    oscillator.stop(this.context.currentTime + i * 0.15 + 0.3);
                });
            }
        };

        const Levels = [
            {
                id: 1,
                name: 'Êï∏Â≠óÈ≠îÊ≥ïÂ∏´',
                icon: 'üßô‚Äç‚ôÇÔ∏è',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2, operator, answer;
                    if (isEasy) {
                        operator = Math.random() > 0.5 ? '+' : '-';
                        if (operator === '+') {
                            num1 = Math.floor(Math.random() * 9) + 1;
                            num2 = Math.floor(Math.random() * (10 - num1)) + 1;
                            answer = num1 + num2;
                        } else {
                            answer = Math.floor(Math.random() * 9) + 1;
                            num2 = Math.floor(Math.random() * answer) + 1;
                            num1 = answer + num2;
                            answer = num1 - num2;
                        }
                    } else {
                        operator = Math.random() > 0.5 ? '+' : '-';
                        if (operator === '+') {
                            num1 = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * (100 - num1)) + 1;
                            answer = num1 + num2;
                        } else {
                            answer = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * answer) + 1;
                            num1 = answer + num2;
                            answer = num1 - num2;
                        }
                    }
                    return {
                        question: `${num1} ${operator} ${num2} = ?`,
                        answer: answer,
                        options: generateOptions(answer, isEasy ? 10 : 100)
                    };
                }
            },
            {
                id: 2,
                name: 'ÊïÖ‰∫ãËø∑ÂÆÆ',
                icon: 'üìñ',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    if (isEasy) {
                        const scenarios = [
                            (a, b) => ({
                                q: `Â∞èÊòéÊúâ ${a} È°ÜÁ≥ñÊûúÔºåÂ™ΩÂ™ΩÂèàÁµ¶‰ªñ ${b} È°ÜÔºåÂ∞èÊòéÁèæÂú®ÊúâÂπæÈ°ÜÁ≥ñÊûúÔºü`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `Ê®π‰∏äÊúâ ${a} ÈöªÂ∞èÈ≥•ÔºåÈ£õËµ∞‰∫Ü ${b} ÈöªÔºåÈÇÑÂâ©‰∏ãÂπæÈöªÂ∞èÈ≥•Ôºü`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `Á±ÉÂ≠êË£°Êúâ ${a} È°ÜËòãÊûúÔºåÂ∞èËèØÂêÉÊéâ ${b} È°ÜÔºåÈÇÑÂâ©‰∏ãÂπæÈ°ÜËòãÊûúÔºü`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `Êõ∏Êû∂‰∏äÂéüÊú¨Êúâ ${a} Êú¨ÊïÖ‰∫ãÊõ∏ÔºåÁà∏Áà∏ÂèàË≤∑‰∫Ü ${b} Êú¨Áµ¶Â∞èÊòéÔºåÁèæÂú®Êõ∏Êû∂‰∏äÂÖ±ÊúâÂπæÊú¨Êõ∏Ôºü`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `Ëä±ÂúíË£°Èñã‰∫Ü ${a} ÊúµÁ¥ÖËä±ÔºåÊóÅÈÇäÈÇÑÊúâ ${b} ÊúµÈªÉËä±ÔºåËä±ÂúíË£°Á∏ΩÂÖ±ÊúâÂπæÊúµËä±Ôºü`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `Â∞èË±¨Êí≤ÊªøË£°Êúâ ${a} ÂÖÉÔºåÂ∞èÁæé‰ªäÂ§©ÂèàÂ≠òÈÄ≤Âéª ${b} ÂÖÉÔºåÁèæÂú®Êí≤ÊªøË£°ÊúâÂ§öÂ∞ëÈå¢Ôºü`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `ÂÅúËªäÂ†¥Ë£°ÂÅú‰∫Ü ${a} ËºõÁ¥ÖËâ≤Ê±ΩËªäÂíå ${b} ËºõËóçËâ≤Ê±ΩËªäÔºåÂÅúËªäÂ†¥Ë£°Á∏ΩÂÖ±ÊúâÂπæËºõËªäÔºü`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `ÂÅúËªäÂ†¥ÂéüÊú¨Êúâ ${a} ËºõËªäÔºåÈñãËµ∞‰∫Ü ${b} ËºõÔºåÁèæÂú®ÂÅúËªäÂ†¥ÈÇÑÂâ©‰∏ãÂπæËºõËªäÔºü`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `ÂÜ∞ÁÆ±Ë£°Êúâ ${a} È°ÜÈõûËõãÔºåÂ™ΩÂ™ΩÂÅöËõãÁ≥ïÁî®Êéâ‰∫Ü ${b} È°ÜÔºåÂÜ∞ÁÆ±ÈÇÑÂâ©‰∏ãÂπæÈ°ÜÈõûËõãÔºü`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `Â∞è‰∏ëÊâã‰∏äÊúâ ${a} ÂÄãÊ∞£ÁêÉÔºå‰∏çÂ∞èÂøÉÈ£õËµ∞‰∫Ü ${b} ÂÄãÔºåÂ∞è‰∏ëÊâã‰∏äÈÇÑÂâ©‰∏ãÂπæÂÄãÊ∞£ÁêÉÔºü`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `ÂÖ¨Ëªä‰∏äÂéüÊú¨Êúâ ${a} ÂÄã‰∫∫ÔºåÂà∞‰∫ÜËªäÁ´ôÂæå‰∏ãËªä‰∫Ü ${b} ÂÄã‰∫∫ÔºåÁèæÂú®Ëªä‰∏äÈÇÑÊúâÂπæÂÄã‰∫∫Ôºü`,
                                a: a - b
                            })
                        ];
                        const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                        const num1 = Math.floor(Math.random() * 15) + 5;
                        const num2 = Math.floor(Math.random() * num1) + 1;
                        const result = scenario(num1, num2);
                        return {
                            question: result.q,
                            answer: result.a,
                            options: generateOptions(result.a, 20)
                        };
                    } else {
                        const scenarios = [
                            () => {
                                const remaining = Math.floor(Math.random() * 15) + 5;
                                const b = Math.floor(Math.random() * 15) + 5;
                                const c = Math.floor(Math.random() * 10) + 5;
                                const a = remaining + b + c;
                                return {
                                    q: `Â∞èÊòéÊúâ ${a} ÂÖÉÔºåË≤∑‰∫Ü‰∏ÄÂÄã ${b} ÂÖÉÁöÑÈ∫µÂåÖÔºåÂèàË≤∑‰∫Ü‰∏ÄÁì∂ ${c} ÂÖÉÁöÑÈ£≤ÊñôÔºåÈÇÑÂâ©‰∏ãÂ§öÂ∞ëÂÖÉÔºü`,
                                    a: remaining
                                };
                            },
                            () => {
                                const finalBooks = Math.floor(Math.random() * 20) + 5;
                                const b = Math.floor(Math.random() * 10) + 3;
                                const c = Math.floor(Math.random() * 15) + 5;
                                const a = finalBooks + b - c;
                                if (a <= 0) {
                                    const adjustedA = Math.floor(Math.random() * 15) + 10;
                                    const adjustedB = Math.floor(Math.random() * (adjustedA - 5)) + 1;
                                    const adjustedC = Math.floor(Math.random() * 10) + 5;
                                    return {
                                        q: `Êõ∏Êû∂‰∏äÊúâ ${adjustedA} Êú¨Êõ∏ÔºåÂ∞èËèØÊãøËµ∞ ${adjustedB} Êú¨ÔºåÂ™ΩÂ™ΩÂèàÊîæ‰∏ä ${adjustedC} Êú¨ÔºåÁèæÂú®ÊúâÂπæÊú¨Êõ∏Ôºü`,
                                        a: adjustedA - adjustedB + adjustedC
                                    };
                                }
                                return {
                                    q: `Êõ∏Êû∂‰∏äÊúâ ${a} Êú¨Êõ∏ÔºåÂ∞èËèØÊãøËµ∞ ${b} Êú¨ÔºåÂ™ΩÂ™ΩÂèàÊîæ‰∏ä ${c} Êú¨ÔºåÁèæÂú®ÊúâÂπæÊú¨Êõ∏Ôºü`,
                                    a: finalBooks
                                };
                            },
                            () => {
                                const price = Math.floor(Math.random() * 30) + 20;
                                const paid = Math.ceil(price / 10) * 10;
                                const change = paid - price;
                                return {
                                    q: `Â∞èËèØË≤∑‰∫Ü‰∏ÄÂÄã ${price} ÂÖÉÁöÑÁé©ÂÖ∑Ôºå‰ªò‰∫Ü ${paid} ÂÖÉÔºåÊáâË©≤ÊâæÂõûÂ§öÂ∞ëÂÖÉÔºü`,
                                    a: change
                                };
                            },
                            () => {
                                const remaining = Math.floor(Math.random() * 15) + 5;
                                const b = Math.floor(Math.random() * 15) + 5;
                                const c = Math.floor(Math.random() * 10) + 5;
                                const a = remaining + b + c;
                                return {
                                    q: `Â∞èÊòéÊúâ ${a} ÂÖÉÔºåË≤∑‰∫Ü‰∏ÄÂÄã ${b} ÂÖÉÁöÑÈ∫µÂåÖÔºåÂèàË≤∑‰∫Ü‰∏ÄÁì∂ ${c} ÂÖÉÁöÑÈ£≤ÊñôÔºåÈÇÑÂâ©‰∏ãÂ§öÂ∞ëÂÖÉÔºü`,
                                    a: remaining
                                };
                            },
                            () => {
                                const finalBooks = Math.floor(Math.random() * 20) + 5;
                                const b = Math.floor(Math.random() * 10) + 3;
                                const c = Math.floor(Math.random() * 15) + 5;
                                const a = Math.max(finalBooks + b - c, 10);
                                const actualFinal = a - b + c;
                                return {
                                    q: `Êõ∏Êû∂‰∏äÊúâ ${a} Êú¨Êõ∏ÔºåÂ∞èËèØÊãøËµ∞ ${b} Êú¨ÔºåÂ™ΩÂ™ΩÂèàÊîæ‰∏ä ${c} Êú¨ÔºåÁèæÂú®ÊúâÂπæÊú¨Êõ∏Ôºü`,
                                    a: actualFinal
                                };
                            },
                            () => {
                                const price = Math.floor(Math.random() * 30) + 20;
                                const paid = Math.ceil(price / 10) * 10;
                                const change = paid - price;
                                return {
                                    q: `Â∞èËèØË≤∑‰∫Ü‰∏ÄÂÄã ${price} ÂÖÉÁöÑÁé©ÂÖ∑Ôºå‰ªò‰∫Ü ${paid} ÂÖÉÔºåÊáâË©≤ÊâæÂõûÂ§öÂ∞ëÂÖÉÔºü`,
                                    a: change
                                };
                            },
                            () => {
                                const initial = Math.floor(Math.random() * 20) + 15;
                                const firstLoss = Math.floor(Math.random() * 8) + 2;
                                const secondGain = Math.floor(Math.random() * 10) + 5;
                                const finalAmount = initial - firstLoss + secondGain;
                                return {
                                    q: `ÂÖ¨ÂúíË£°ÂéüÊú¨Êúâ ${initial} ÈöªÈ¥øÂ≠êÔºåÈ£õËµ∞‰∫Ü ${firstLoss} ÈöªÔºåÂæå‰æÜÂèàÈ£õ‰æÜ‰∫Ü ${secondGain} ÈöªÔºåÁèæÂú®ÂÖ¨ÂúíË£°ÈÇÑÊúâÂπæÈöªÈ¥øÂ≠êÔºü`,
                                    a: finalAmount
                                };
                            },
                            () => {
                                const sectionA = Math.floor(Math.random() * 15) + 10;
                                const sectionB = Math.floor(Math.random() * 10) + 5;
                                const sectionC = Math.floor(Math.random() * 10) + 5;
                                const total = sectionA + sectionB + sectionC;
                                return {
                                    q: `Ëæ≤Â§´Âú®ËèúÂúíË£°Á®Æ‰∫Ü ${sectionA} Ê†πËòøËîîÔºå ${sectionB} Ê¢ùÂú∞ÁìúÔºåÈÇÑÊúâ ${sectionC} Ê†πÁéâÁ±≥ÔºåËæ≤Â§´Á∏ΩÂÖ±Á®Æ‰∫ÜÂ§öÂ∞ëÊ†π‰ΩúÁâ©Ôºü`,
                                    a: total
                                };
                            }
                        ];
                        const scenario = scenarios[Math.floor(Math.random() * scenarios.length)]();
                        return {
                            question: scenario.q,
                            answer: scenario.a,
                            options: generateOptions(scenario.a, 50)
                        };
                    }
                }
            },
            {
                id: 3,
                name: '‰πòÊ≥ïÊé¢Èö™ÂÆ∂',
                icon: '‚úñÔ∏è',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2;
                    if (isEasy) {
                        const multipliers = [2, 3, 4, 5];
                        num1 = multipliers[Math.floor(Math.random() * multipliers.length)];
                        num2 = Math.floor(Math.random() * 9) + 1;
                    } else {
                        num1 = Math.floor(Math.random() * 9) + 1;
                        num2 = Math.floor(Math.random() * 9) + 1;
                    }
                    const answer = num1 * num2;
                    return {
                        question: `${num1} √ó ${num2} = ?`,
                        answer: answer,
                        options: generateOptions(answer, isEasy ? 50 : 81)
                    };
                }
            },
            {
                id: 4,
                name: 'Â§ßÂ∞èÈ≠îÁéãÊà∞',
                icon: '‚öîÔ∏è',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2;
                    if (isEasy) {
                        num1 = Math.floor(Math.random() * 90) + 10;
                        num2 = Math.floor(Math.random() * 90) + 10;
                    } else {
                        num1 = Math.floor(Math.random() * 900) + 100;
                        num2 = Math.floor(Math.random() * 900) + 100;
                    }
                    let answer;
                    if (num1 > num2) answer = '>';
                    else if (num1 < num2) answer = '<';
                    else answer = '=';
                    return {
                        question: `${num1} _____ ${num2}`,
                        answer: answer,
                        options: ['<', '>', '='],
                        isComparison: true
                    };
                }
            },
            {
                id: 5,
                name: 'Èå¢Âπ£Â§ßÂØåÁøÅ',
                icon: 'üí∞',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    if (isEasy) {
                        const coins = [
                            { value: 1, count: Math.floor(Math.random() * 5) },
                            { value: 5, count: Math.floor(Math.random() * 4) },
                            { value: 10, count: Math.floor(Math.random() * 3) }
                        ];
                        const total = coins.reduce((sum, coin) => sum + coin.value * coin.count, 0);
                        const description = coins
                            .filter(c => c.count > 0)
                            .map(c => `<span class="coin-tag">${c.count}ÂÄã${c.value}ÂÖÉ</span>`)
                            .join('');
                        return {
                            question: `‰Ω†ÊúâÈÄô‰∫õÈå¢ÔºåÁ∏ΩÂÖ±ÊúâÂ§öÂ∞ëÂÖÉÔºü`,
                            coinsHtml: description,
                            answer: total,
                            options: generateOptions(total, 50)
                        };
                    } else {
                        const coins = [
                            { value: 1, count: Math.floor(Math.random() * 5) },
                            { value: 5, count: Math.floor(Math.random() * 3) },
                            { value: 10, count: Math.floor(Math.random() * 3) },
                            { value: 50, count: Math.floor(Math.random() * 2) },
                            { value: 100, count: Math.floor(Math.random() * 2) }
                        ];
                        const total = coins.reduce((sum, coin) => sum + coin.value * coin.count, 0);
                        const description = coins
                            .filter(c => c.count > 0)
                            .map(c => `<span class="coin-tag">${c.count}ÂÄã${c.value}ÂÖÉ</span>`)
                            .join('');
                        return {
                            question: `‰Ω†ÊúâÈÄô‰∫õÈå¢ÔºåÁ∏ΩÂÖ±ÊúâÂ§öÂ∞ëÂÖÉÔºü`,
                            coinsHtml: description,
                            answer: total,
                            options: generateOptions(total, 300)
                        };
                    }
                }
            },
            {
                id: 6,
                name: 'ÊôÇÈñìÈ≠îÊ≥ïÈêò',
                icon: 'üïê',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let hour, minute, answer;
                    if (isEasy) {
                        // Easy mode: 5-minute intervals
                        hour = Math.floor(Math.random() * 12) + 1;
                        minute = Math.floor(Math.random() * 12) * 5;
                    } else {
                        // Hard mode: 1-minute intervals
                        hour = Math.floor(Math.random() * 12) + 1;
                        minute = Math.floor(Math.random() * 60);
                    }
                    const formatTime = (h, m) => `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    answer = formatTime(hour, minute);
                    return {
                        question: 'ÁèæÂú®ÊòØÂπæÈªûÔºü',
                        answer: answer,
                        hour: hour,
                        minute: minute,
                        options: generateTimeOptions(hour, minute, isEasy),
                        isClock: true
                    };
                }
            }
        ];

        // Áç®Á´ãÁöÑÁ∑¥ÁøíÈóúÂç°
        const PracticeLevels = [
            {
                id: 99,
                name: '‰πù‰πù‰πòÊ≥ïÁéã',
                icon: 'üî¢',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2;

                    if (isEasy) {
                        // Á∞°ÂñÆÊ®°ÂºèÔºö2-5ÁöÑ‰πòÊ≥ïË°®
                        num1 = Math.floor(Math.random() * 4) + 2;
                        num2 = Math.floor(Math.random() * 8) + 2;
                    } else {
                        // Âõ∞Èõ£Ê®°ÂºèÔºöÂÆåÊï¥‰πù‰πù‰πòÊ≥ïË°® 2-9
                        num1 = Math.floor(Math.random() * 8) + 2;
                        num2 = Math.floor(Math.random() * 8) + 2;
                    }

                    const answer = num1 * num2;

                    // Áî¢ÁîüÊõ¥ÂÖ∑ÊåëÊà∞ÊÄßÁöÑÈÅ∏È†Ö
                    const generateMultiplicationOptions = (correct) => {
                        const options = [correct];
                        const possibleAnswers = [];

                        // ÁîüÊàêÁõ∏ËøëÁöÑ‰πòÊ≥ïÁµêÊûú‰ΩúÁÇ∫Âπ≤ÊìæÈÅ∏È†Ö
                        for (let i = 2; i <= 9; i++) {
                            for (let j = 2; j <= 9; j++) {
                                const result = i * j;
                                if (result !== correct && Math.abs(result - correct) <= 20) {
                                    possibleAnswers.push(result);
                                }
                            }
                        }

                        // Èö®Ê©üÈÅ∏Êìá3ÂÄã‰∏çÈáçË§áÁöÑÂπ≤ÊìæÈÅ∏È†Ö
                        while (options.length < 4 && possibleAnswers.length > 0) {
                            const randomIndex = Math.floor(Math.random() * possibleAnswers.length);
                            const option = possibleAnswers[randomIndex];
                            if (!options.includes(option)) {
                                options.push(option);
                            }
                            possibleAnswers.splice(randomIndex, 1);
                        }

                        // Â¶ÇÊûúÈÇÑ‰∏çÂ§†4ÂÄãÈÅ∏È†ÖÔºåË£úÂÖÖ‰∏Ä‰∫õÁõ∏ËøëÊï∏Â≠ó
                        while (options.length < 4) {
                            const offset = Math.floor(Math.random() * 10) + 1;
                            const option = Math.random() > 0.5 ? correct + offset : correct - offset;
                            if (option > 0 && !options.includes(option)) {
                                options.push(option);
                            }
                        }

                        return shuffleArray(options);
                    };

                    return {
                        question: `${num1} √ó ${num2} = ?`,
                        answer: answer,
                        options: generateMultiplicationOptions(answer)
                    };
                }
            }
        ];

        function generateOptions(correctAnswer, range) {
            const options = [correctAnswer];
            while (options.length < 4) {
                let option;
                if (typeof correctAnswer === 'number') {
                    const offset = Math.floor(Math.random() * 20) - 10;
                    option = correctAnswer + offset;
                    if (option < 0) option = Math.abs(option);
                    if (option > range) option = option % range;
                } else {
                    option = Math.floor(Math.random() * range);
                }
                if (!options.includes(option) && option >= 0) {
                    options.push(option);
                }
            }
            return shuffleArray(options);
        }

        function generateTimeOptions(hour, minute, isEasy) {
            const formatTime = (h, m) => `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            const correctAnswer = formatTime(hour, minute);
            const options = [correctAnswer];
            while (options.length < 6) {
                // Ê≠•È©ü 1: ËÆìÂ∞èÊôÇ h Êé•ËøëÁ≠îÊ°à hour (+- 1 Â∞èÊôÇ)
                let h;
                const hourRange = 1; // Êé•ËøëÁØÑÂúçÔºö+- 1 Â∞èÊôÇ

                // Âú® [hour - 1, hour + 1] ÁØÑÂúçÂÖßÈö®Ê©üÁîüÊàêÂ∞èÊôÇ (‰ΩÜÈúÄËÄÉÊÖÆ 12 Â∞èÊôÇÂà∂)
                const minH = hour - hourRange;
                const maxH = hour + hourRange;

                // Èö®Ê©üÂú® minH Âà∞ maxH ‰πãÈñìÁîüÊàê h
                h = Math.floor(Math.random() * (maxH - minH + 1)) + minH;

                // ËôïÁêÜ h Ë∂ÖÂá∫ 1-12 ÁØÑÂúçÁöÑÊÉÖÊ≥ÅÔºå‰æãÂ¶Ç 12 + 1 = 1Ôºå 1 - 1 = 12
                h = (h < 1) ? 12 : (h > 12) ? 1 : h;

                // Ê≠•È©ü 2: ËÆìÂàÜÈêò m Êé•ËøëÁ≠îÊ°à minute (+- 15 ÂàÜÈêò)
                let m;
                const minuteRange = 3;
                const minM = Math.max(0, minute - minuteRange);
                const maxM = Math.min(59, minute + minuteRange);

                if (isEasy) {
                    // Âú®Êé•ËøëÁØÑÂúçÂÖßÁîüÊàê 5 ÁöÑÂÄçÊï∏
                    m = Math.floor(Math.random() * ((maxM - minM) / 5 + 1)) * 5 + minM;
                    m = Math.round(m / 5) * 5;
                } else {
                    // Âú®Êé•ËøëÁØÑÂúçÂÖßÁîüÊàê‰ªªÊÑèÂàÜÈêò
                    m = Math.floor(Math.random() * (maxM - minM + 1)) + minM;
                }

                const option = formatTime(h, m);
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function drawClock(hour, minute) {
            const container = document.getElementById('clockContainerInner');
            if (!container) return;
            let ticksHtml = '';
            for (let i = 0; i < 60; i++) {
                const isHour = i % 5 === 0;
                const h = isHour ? 10 : 5; // px
                const w = isHour ? 2 : 1; // px
                const angle = i * 6;

                ticksHtml += `<div style="
                    position: absolute;
                    top: 0;
                    left: 50%;
                    width: ${w}px;
                    height: 50%;
                    transform-origin: bottom center;
                    transform: translateX(-50%) rotate(${angle}deg);
                    pointer-events: none;
                ">
                    <div style="
                        width: 100%;
                        height: ${isHour ? 15 : 8}%;
                        background: #333;
                    "></div>
                </div>`;
            }

            let numbersHtml = '';
            for (let i = 1; i <= 12; i++) {
                const angleRad = (i * 30 - 90) * (Math.PI / 180);
                const radius = 38;
                const x = 50 + radius * Math.cos(angleRad);
                const y = 50 + radius * Math.sin(angleRad);
                numbersHtml += `<div class="clock-number" style="left: ${x}%; top: ${y}%">${i}</div>`;
            }
            container.innerHTML = `
                ${ticksHtml}
                ${numbersHtml}
                <div class="clock-center"></div>
                <div class="clock-hand hour-hand" style="transform: rotate(${(hour % 12) * 30 + minute * 0.5}deg)"></div>
                <div class="clock-hand minute-hand" style="transform: rotate(${minute * 6}deg)"></div>
            `;
        }

        const Storage = {
            getRecord(levelId, difficulty) {
                const key = `level_${levelId}_${difficulty}`;
                return parseInt(localStorage.getItem(key)) || 0;
            },
            saveRecord(levelId, difficulty, stars) {
                const key = `level_${levelId}_${difficulty}`;
                const current = this.getRecord(levelId, difficulty);
                if (stars > current) {
                    localStorage.setItem(key, stars);
                }
            }
        };

        let gameState = {
            currentLevel: null,
            difficulty: null,
            questionIndex: 0,
            errors: 0,
            correctCount: 0,
            totalQuestions: 10,
            questions: []
        };

        function renderLevelMap() {
            // Ê∏≤Êüì‰∏ÄËà¨ÈóúÂç°
            const mapContainer = document.getElementById('levelMap');
            mapContainer.innerHTML = '';
            Levels.forEach(level => {
                const easyStars = Storage.getRecord(level.id, 'easy');
                const hardStars = Storage.getRecord(level.id, 'hard');
                const card = document.createElement('div');
                card.className = 'level-card';
                card.onclick = () => openDifficultyModal(level.id);
                card.innerHTML = `
                    <div class="level-icon">${level.icon}</div>
                    <h3>${level.name}</h3>
                    <div class="level-records">
                        <div class="record-item">
                            <div class="label">Á∞°ÂñÆ</div>
                            <div class="stars">${'‚≠ê'.repeat(easyStars)}${'‚òÜ'.repeat(3 - easyStars)}</div>
                        </div>
                        <div class="record-item">
                            <div class="label">Âõ∞Èõ£</div>
                            <div class="stars">${'‚≠ê'.repeat(hardStars)}${'‚òÜ'.repeat(3 - hardStars)}</div>
                        </div>
                    </div>
                `;
                mapContainer.appendChild(card);
            });

            // Ê∏≤ÊüìÁ∑¥ÁøíÈóúÂç°
            const practiceContainer = document.getElementById('practiceMap');
            practiceContainer.innerHTML = '';
            PracticeLevels.forEach(level => {
                const card = document.createElement('div');
                card.className = 'practice-card';
                card.onclick = () => openPracticeLevel(level.id);
                card.innerHTML = `
                    <div class="practice-icon">${level.icon}</div>
                    <h3>${level.name}</h3>
                    <div class="practice-description">
                        ÁÑ°ÈôêÁ∑¥ÁøíÊ®°Âºè<br>
                        üí™ ÊåÅÁ∫åÊåëÊà∞‰πù‰πù‰πòÊ≥ïË°® üí™<br>
                        <small>ÁÑ°ÈåØË™§ÈôêÂà∂ ‚Ä¢ ÁÑ°ÊôÇÈñìÂ£ìÂäõ</small>
                    </div>
                `;
                practiceContainer.appendChild(card);
            });
        }

        function openDifficultyModal(levelId) {
            gameState.currentLevel = Levels.find(l => l.id === levelId);
            const modal = document.getElementById('difficultyModal');
            const title = document.getElementById('modalTitle');
            title.textContent = `${gameState.currentLevel.name} - ÈÅ∏ÊìáÈõ£Â∫¶`;
            modal.classList.add('active');
        }

        function openPracticeLevel(levelId) {
            gameState.currentLevel = PracticeLevels.find(l => l.id === levelId);
            if (levelId === 99) { // ‰πù‰πù‰πòÊ≥ïÁéã
                startMultiplicationPractice();
            }
        }

        function closeModal() {
            document.getElementById('difficultyModal').classList.remove('active');
        }

        // ‰πù‰πù‰πòÊ≥ïÁéãÂ∞àÁî®Á∑¥ÁøíÊ®°Âºè
        function startMultiplicationPractice() {
            gameState.difficulty = 'practice';
            gameState.questionIndex = 0;
            gameState.errors = 0;
            gameState.correctCount = 0;
            gameState.isPracticeMode = true;

            // Èö±ËóèÊâÄÊúâ‰∏ªÈÅ∏ÂñÆÂÖÉÁ¥†ÔºàËàáÂÖ∂‰ªñÈóúÂç°‰∏ÄËá¥Ôºâ
            document.getElementById('levelMap').style.display = 'none';
            document.querySelector('.practice-section').style.display = 'none';
            document.querySelector('.game-title').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');
            updatePracticeUI();
            generateNewMultiplicationQuestion();
        }

        function updatePracticeUI() {
            document.getElementById('levelName').textContent = gameState.currentLevel.name + ' - Á∑¥ÁøíÊ®°Âºè';
            document.getElementById('questionNumber').textContent = gameState.questionIndex + 1;
            document.getElementById('totalQuestions').textContent = '‚àû';

            // Èö±ËóèÈåØË™§Ë®àÊï∏ÂíåÈÄ≤Â∫¶Ê¢ùÔºàÁ∑¥ÁøíÊ®°Âºè‰∏çÈúÄË¶ÅÔºâ
            document.getElementById('errorCount').parentElement.style.display = 'none';
            document.getElementById('progressFill').parentElement.style.display = 'none';
        }

        function generateNewMultiplicationQuestion() {
            // Èö®Ê©üÈÅ∏Êìá 2-9 ÁöÑ‰πòÊ≥ïË°®
            const num1 = Math.floor(Math.random() * 8) + 2;
            const num2 = Math.floor(Math.random() * 8) + 2;
            const answer = num1 * num2;

            const generateMultiplicationOptions = (correct) => {
                const options = [correct];
                const possibleAnswers = [];

                // ÁîüÊàêÁõ∏ËøëÁöÑ‰πòÊ≥ïÁµêÊûú‰ΩúÁÇ∫Âπ≤ÊìæÈÅ∏È†Ö
                for (let i = 2; i <= 9; i++) {
                    for (let j = 2; j <= 9; j++) {
                        const result = i * j;
                        if (result !== correct && Math.abs(result - correct) <= 20) {
                            possibleAnswers.push(result);
                        }
                    }
                }

                // Èö®Ê©üÈÅ∏Êìá3ÂÄã‰∏çÈáçË§áÁöÑÂπ≤ÊìæÈÅ∏È†Ö
                while (options.length < 4 && possibleAnswers.length > 0) {
                    const randomIndex = Math.floor(Math.random() * possibleAnswers.length);
                    const option = possibleAnswers[randomIndex];
                    if (!options.includes(option)) {
                        options.push(option);
                    }
                    possibleAnswers.splice(randomIndex, 1);
                }

                // Â¶ÇÊûúÈÇÑ‰∏çÂ§†4ÂÄãÈÅ∏È†ÖÔºåË£úÂÖÖ‰∏Ä‰∫õÁõ∏ËøëÊï∏Â≠ó
                while (options.length < 4) {
                    const offset = Math.floor(Math.random() * 10) + 1;
                    const option = Math.random() > 0.5 ? correct + offset : correct - offset;
                    if (option > 0 && !options.includes(option)) {
                        options.push(option);
                    }
                }

                return shuffleArray(options);
            };

            const currentQuestion = {
                question: `${num1} √ó ${num2} = ?`,
                answer: answer,
                options: generateMultiplicationOptions(answer)
            };

            showPracticeQuestion(currentQuestion);
        }

        function showPracticeQuestion(question) {
            const questionContent = document.getElementById('questionContent');
            const answersContainer = document.getElementById('answersContainer');
            const clockContainer = document.getElementById('clockContainer');

            questionContent.textContent = question.question;
            clockContainer.innerHTML = '';
            answersContainer.innerHTML = '';

            question.options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = option;
                btn.onclick = () => checkPracticeAnswer(option, btn, question.answer);
                answersContainer.appendChild(btn);
            });
        }

        function checkPracticeAnswer(selected, btnElement, correctAnswer) {
            const isCorrect = selected === correctAnswer;

            // Á¶ÅÁî®ÊâÄÊúâÊåâÈàï
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
            });

            if (isCorrect) {
                btnElement.classList.add('correct');
                AudioSystem.playCorrect();
                gameState.correctCount++;
                gameState.questionIndex++;

                // 1ÁßíÂæåËá™ÂãïÈÄ≤ÂÖ•‰∏ã‰∏ÄÈ°å
                setTimeout(() => {
                    updatePracticeUI();
                    generateNewMultiplicationQuestion();
                }, 1000);
            } else {
                btnElement.classList.add('wrong');
                AudioSystem.playWrong();

                // È´ò‰∫ÆÈ°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°à
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    if (btn.textContent === String(correctAnswer)) {
                        btn.classList.add('correct');
                    }
                });

                // 2ÁßíÂæåËá™ÂãïÈÄ≤ÂÖ•‰∏ã‰∏ÄÈ°åÔºàÁµ¶Êõ¥Â§öÊôÇÈñìÊü•ÁúãÊ≠£Á¢∫Á≠îÊ°àÔºâ
                setTimeout(() => {
                    gameState.questionIndex++;
                    updatePracticeUI();
                    generateNewMultiplicationQuestion();
                }, 2000);
            }
        }

        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            gameState.questionIndex = 0;
            gameState.errors = 0;
            gameState.correctCount = 0;
            gameState.questions = [];
            for (let i = 0; i < gameState.totalQuestions; i++) {
                gameState.questions.push(gameState.currentLevel.generateQuestion(difficulty));
            }
            closeModal();

            // Èö±ËóèÊâÄÊúâ‰∏ªÈÅ∏ÂñÆÂÖÉÁ¥†
            document.getElementById('levelMap').style.display = 'none';
            document.querySelector('.practice-section').style.display = 'none';
            document.querySelector('.game-title').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');
            updateGameUI();
            showQuestion();
        }

        function updateGameUI() {
            document.getElementById('levelName').textContent = gameState.currentLevel.name;
            document.getElementById('questionNumber').textContent = gameState.questionIndex + 1;
            document.getElementById('totalQuestions').textContent = gameState.totalQuestions;
            document.getElementById('errorCount').textContent = gameState.errors;
            const progress = ((gameState.questionIndex) / gameState.totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showQuestion() {
            const question = gameState.questions[gameState.questionIndex];
            const questionContent = document.getElementById('questionContent');
            const answersContainer = document.getElementById('answersContainer');
            const clockContainer = document.getElementById('clockContainer');
            questionContent.textContent = question.question;
            clockContainer.innerHTML = '';
            // Handle coin visualization
            if (question.coinsHtml) {
                const coinDiv = document.createElement('div');
                coinDiv.className = 'coin-container';
                coinDiv.innerHTML = question.coinsHtml;
                clockContainer.appendChild(coinDiv);
            }
            if (question.isClock) {
                const clockDiv = document.createElement('div');
                clockDiv.id = 'clockContainerInner';
                clockDiv.className = 'clock-canvas';
                clockContainer.appendChild(clockDiv);
                drawClock(question.hour, question.minute);
            }
            answersContainer.innerHTML = '';
            question.options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option, btn);
                answersContainer.appendChild(btn);
            });
        }

        function checkAnswer(selected, btnElement) {
            const question = gameState.questions[gameState.questionIndex];
            const isCorrect = selected === question.answer;
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
            });
            if (isCorrect) {
                btnElement.classList.add('correct');
                AudioSystem.playCorrect();
                gameState.correctCount++;
                setTimeout(() => {
                    gameState.questionIndex++;
                    if (gameState.questionIndex >= gameState.totalQuestions) {
                        endGame();
                    } else {
                        updateGameUI();
                        showQuestion();
                    }
                }, 1000);
            } else {
                btnElement.classList.add('wrong');
                AudioSystem.playWrong();
                gameState.errors++;
                document.getElementById('errorCount').textContent = gameState.errors;

                // Highlight the correct answer
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    if (btn.textContent === String(question.answer)) {
                        btn.classList.add('correct');
                    }
                });

                if (gameState.errors >= 3) {
                    setTimeout(() => {
                        endGame();
                    }, 1000);
                } else {
                    setTimeout(() => {
                        gameState.questionIndex++;
                        if (gameState.questionIndex >= gameState.totalQuestions) {
                            endGame();
                        } else {
                            updateGameUI();
                            showQuestion();
                        }
                    }, 1000);
                }
            }
        }

        function endGame() {
            const correctAnswers = gameState.correctCount;
            let stars = 0;
            if (gameState.errors === 0) stars = 3;
            else if (gameState.errors === 1) stars = 2;
            else if (gameState.errors === 2) stars = 1;
            Storage.saveRecord(gameState.currentLevel.id, gameState.difficulty, stars);
            document.getElementById('gameScreen').classList.remove('active');
            const resultScreen = document.getElementById('resultScreen');
            resultScreen.classList.add('active');
            const resultTitle = document.getElementById('resultTitle');
            const resultStars = document.getElementById('resultStars');
            const resultMessage = document.getElementById('resultMessage');
            if (stars === 3) {
                resultTitle.textContent = 'Â§™Ê£í‰∫ÜÔºÅÂÆåÁæéÈÅéÈóúÔºÅ';
                resultMessage.textContent = `‰Ω†Á≠îÂ∞ç‰∫ÜÂÖ®ÈÉ® ${gameState.totalQuestions} È°åÔºÅ`;
                AudioSystem.playComplete();
            } else if (stars > 0) {
                resultTitle.textContent = 'ÂÅöÂæóÂ•ΩÔºÅ';
                resultMessage.textContent = `‰Ω†Á≠îÂ∞ç‰∫Ü ${correctAnswers} È°åÔºåÁπºÁ∫åÂä†Ê≤πÔºÅ`;
                AudioSystem.playComplete();
            } else {
                resultTitle.textContent = 'ÂÜçÊé•ÂÜçÂé≤ÔºÅ';
                resultMessage.textContent = `ÈÄôÊ¨°Á≠îÂ∞ç‰∫Ü ${correctAnswers} È°åÔºå‰∏ãÊ¨°‰∏ÄÂÆöÊúÉÊõ¥Â•ΩÔºÅ`;
            }
            resultStars.textContent = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
        }

        function exitGame() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈõ¢ÈñãÈÅäÊà≤ÂóéÔºüÈÄ≤Â∫¶Â∞á‰∏çÊúÉ‰øùÂ≠ò„ÄÇ')) {
                backToMap();
            }
        }

        function retryLevel() {
            document.getElementById('resultScreen').classList.remove('active');
            startGame(gameState.difficulty);
        }

        function backToMap() {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('resultScreen').classList.remove('active');
            document.getElementById('levelMap').style.display = 'grid';
            renderLevelMap();
            document.querySelector('.practice-section').style.display = 'block';
            document.querySelector('.game-title').style.display = 'block';
        }

        window.onload = () => {
            AudioSystem.init();
            renderLevelMap();
        };
    </script>
</body>

</html>
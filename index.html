<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”æ³•æ£®æ—æ•¸å­¸æ¢éšª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* æ¨™é¡Œå€åŸŸ */
        .game-title {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-title h1 {
            font-size: clamp(28px, 6vw, 48px);
            margin-bottom: 10px;
            animation: titleFloat 3s ease-in-out infinite;
        }

        @keyframes titleFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* é—œå¡åœ°åœ– */
        .level-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .level-card {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .level-card:hover::before {
            left: 100%;
        }

        .level-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .level-card h3 {
            font-size: clamp(20px, 4vw, 26px);
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .level-icon {
            font-size: clamp(40px, 8vw, 60px);
            text-align: center;
            margin-bottom: 15px;
        }

        .level-records {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            gap: 10px;
        }

        .record-item {
            text-align: center;
            flex: 1;
        }

        .record-item .label {
            font-size: clamp(12px, 2.5vw, 14px);
            color: #666;
            margin-bottom: 5px;
        }

        .stars {
            font-size: clamp(16px, 3.5vw, 20px);
            color: #ffd700;
        }

        /* ç·´ç¿’å€åŸŸæ¨£å¼ */
        .practice-section {
            margin-top: 50px;
            padding: 30px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(255, 154, 158, 0.4);
        }

        .practice-title {
            text-align: center;
            color: white;
            font-size: clamp(24px, 5vw, 32px);
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: practiceGlow 2s ease-in-out infinite alternate;
        }

        @keyframes practiceGlow {
            from {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 255, 255, 0.5);
            }

            to {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.8);
            }
        }

        .practice-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            justify-items: center;
        }

        .practice-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
            background-clip: padding-box;
            max-width: 400px;
        }

        .practice-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 204, 0, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .practice-card:hover::before {
            left: 100%;
        }

        .practice-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 154, 158, 0.5);
            border-color: #ffcc00;
        }

        .practice-card h3 {
            font-size: clamp(22px, 4vw, 28px);
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .practice-icon {
            font-size: clamp(50px, 10vw, 70px);
            text-align: center;
            margin-bottom: 20px;
            animation: practiceFloat 3s ease-in-out infinite;
        }

        @keyframes practiceFloat {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-8px) rotate(5deg);
            }
        }

        .practice-description {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
            margin-top: 15px;
        }

        /* é›£åº¦é¸æ“‡å½ˆçª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 25px;
            font-size: clamp(22px, 5vw, 28px);
        }

        .difficulty-buttons {
            display: flex;
            gap: 15px;
            flex-direction: column;
        }

        .difficulty-btn {
            padding: 20px;
            font-size: clamp(18px, 4vw, 22px);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn.easy {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2c5f2d;
        }

        .difficulty-btn.hard {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #8b2500;
        }

        .difficulty-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .close-modal {
            background: #ccc;
            color: #333;
            margin-top: 15px;
            padding: 12px;
            font-size: clamp(16px, 3.5vw, 18px);
        }

        /* éŠæˆ²ç•«é¢ */
        .game-screen {
            display: none;
            background: white;
            border-radius: 25px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .game-screen.active {
            display: block;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .info-item {
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            color: #667eea;
        }

        .back-btn {
            padding: 12px 24px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .question-area {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .question-text {
            font-size: clamp(18px, 4vw, 24px);
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* æ™‚é˜é¡¯ç¤º */
        .clock-display {
            width: clamp(150px, 40vw, 250px);
            height: clamp(150px, 40vw, 250px);
            border: 8px solid #333;
            border-radius: 50%;
            position: relative;
            background: white;
            margin: 20px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .clock-center {
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            background: #333;
        }

        .hour-hand {
            width: 6px;
            height: 25%;
            background: #333;
            margin-left: -3px;
        }

        .minute-hand {
            width: 4px;
            height: 35%;
            background: #666;
            margin-left: -2px;
        }

        .clock-number {
            position: absolute;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            color: #333;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            margin-top: -10px;
            margin-left: -10px;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .answer-btn {
            padding: 20px;
            font-size: clamp(16px, 3.5vw, 20px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            min-height: 60px;
        }

        .answer-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .answer-btn:active {
            transform: translateY(0);
        }

        .answer-btn.correct {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            animation: correctPulse 0.5s ease;
        }

        .answer-btn.wrong {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            animation: wrongShake 0.5s ease;
        }

        @keyframes correctPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes wrongShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
            transition: width 0.3s ease;
        }

        /* çµæœç•«é¢ */
        .result-screen {
            display: none;
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .result-screen.active {
            display: block;
            animation: modalSlideIn 0.5s ease;
        }

        .result-screen h2 {
            font-size: clamp(28px, 6vw, 36px);
            color: #667eea;
            margin-bottom: 20px;
        }

        .result-stars {
            font-size: clamp(40px, 10vw, 60px);
            margin: 20px 0;
        }

        .result-message {
            font-size: clamp(18px, 4vw, 22px);
            color: #666;
            margin-bottom: 30px;
        }

        .result-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .result-btn {
            padding: 15px 30px;
            font-size: clamp(16px, 3.5vw, 18px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .retry-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .home-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .result-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .level-map {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .game-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .answers-grid {
                grid-template-columns: 1fr;
            }

            .difficulty-buttons {
                gap: 12px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .level-map {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* è§¸æ§å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {

            .answer-btn,
            .difficulty-btn,
            .result-btn,
            .back-btn {
                min-height: 50px;
                padding: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- éŠæˆ²æ¨™é¡Œ -->
        <div class="game-title">
            <h1>ğŸŒ³ é­”æ³•æ£®æ—æ•¸å­¸æ¢éšª ğŸŒ³</h1>
            <p>é¸æ“‡é—œå¡é–‹å§‹å†’éšªå§ï¼</p>
        </div>

        <!-- é—œå¡åœ°åœ– -->
        <div id="levelMap" class="level-map"></div>

        <!-- ç·´ç¿’å€åŸŸ -->
        <div class="practice-section">
            <h2 class="practice-title">ğŸ”¥ ç‰¹åˆ¥ç·´ç¿’å€ ğŸ”¥</h2>
            <div id="practiceMap" class="practice-map"></div>
        </div>

        <!-- é›£åº¦é¸æ“‡å½ˆçª— -->
        <div id="difficultyModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">é¸æ“‡é›£åº¦</h2>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn easy" onclick="startGame('easy')">
                        ğŸŒ± ç°¡å–®æ¨¡å¼
                    </button>
                    <button class="difficulty-btn hard" onclick="startGame('hard')">
                        ğŸ”¥ å›°é›£æ¨¡å¼
                    </button>
                    <button class="difficulty-btn close-modal" onclick="closeModal()">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- éŠæˆ²ç•«é¢ -->
        <div id="gameScreen" class="game-screen">
            <div class="game-header">
                <div class="game-info">
                    <div class="info-item">
                        <span id="levelName">é—œå¡åç¨±</span>
                    </div>
                    <div class="info-item">
                        é¡Œç›®: <span id="questionNumber">1</span>/<span id="totalQuestions">10</span>
                    </div>
                    <div class="info-item">
                        éŒ¯èª¤: <span id="errorCount">0</span>/3
                    </div>
                </div>
                <button class="back-btn" onclick="exitGame()">è¿”å›åœ°åœ–</button>
            </div>

            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="question-area">
                <div id="questionContent" class="question-text"></div>
                <div id="clockContainer"></div>
            </div>

            <div id="answersContainer" class="answers-grid"></div>
        </div>

        <!-- çµæœç•«é¢ -->
        <div id="resultScreen" class="result-screen">
            <h2 id="resultTitle">æ­å–œå®Œæˆï¼</h2>
            <div id="resultStars" class="result-stars"></div>
            <div id="resultMessage" class="result-message"></div>
            <div class="result-buttons">
                <button class="result-btn retry-btn" onclick="retryLevel()">å†ç©ä¸€æ¬¡</button>
                <button class="result-btn home-btn" onclick="backToMap()">è¿”å›åœ°åœ–</button>
            </div>
        </div>
    </div>

    <script>
        const AudioSystem = {
            context: null,
            init() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
            },
            playCorrect() {
                if (!this.context) this.init();
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                oscillator.frequency.setValueAtTime(523.25, this.context.currentTime);
                oscillator.frequency.setValueAtTime(659.25, this.context.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(783.99, this.context.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.3);
            },
            playWrong() {
                if (!this.context) this.init();
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                oscillator.frequency.setValueAtTime(200, this.context.currentTime);
                oscillator.type = 'sawtooth';
                gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.2);
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.2);
            },
            playComplete() {
                if (!this.context) this.init();
                const notes = [523.25, 587.33, 659.25, 783.99];
                notes.forEach((freq, i) => {
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    oscillator.frequency.setValueAtTime(freq, this.context.currentTime + i * 0.15);
                    gainNode.gain.setValueAtTime(0.2, this.context.currentTime + i * 0.15);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + i * 0.15 + 0.3);
                    oscillator.start(this.context.currentTime + i * 0.15);
                    oscillator.stop(this.context.currentTime + i * 0.15 + 0.3);
                });
            }
        };

        const Levels = [
            {
                id: 1,
                name: 'æ•¸å­—é­”æ³•å¸«',
                icon: 'ğŸ§™â€â™‚ï¸',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2, operator, answer;
                    if (isEasy) {
                        operator = Math.random() > 0.5 ? '+' : '-';
                        if (operator === '+') {
                            num1 = Math.floor(Math.random() * 9) + 1;
                            num2 = Math.floor(Math.random() * (10 - num1)) + 1;
                            answer = num1 + num2;
                        } else {
                            answer = Math.floor(Math.random() * 9) + 1;
                            num2 = Math.floor(Math.random() * answer) + 1;
                            num1 = answer + num2;
                            answer = num1 - num2;
                        }
                    } else {
                        operator = Math.random() > 0.5 ? '+' : '-';
                        if (operator === '+') {
                            num1 = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * (100 - num1)) + 1;
                            answer = num1 + num2;
                        } else {
                            answer = Math.floor(Math.random() * 90) + 10;
                            num2 = Math.floor(Math.random() * answer) + 1;
                            num1 = answer + num2;
                            answer = num1 - num2;
                        }
                    }
                    return {
                        question: `${num1} ${operator} ${num2} = ?`,
                        answer: answer,
                        options: generateOptions(answer, isEasy ? 10 : 100)
                    };
                }
            },
            {
                id: 2,
                name: 'æ•…äº‹è¿·å®®',
                icon: 'ğŸ“–',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    if (isEasy) {
                        const scenarios = [
                            (a, b) => ({
                                q: `å°æ˜æœ‰ ${a} é¡†ç³–æœï¼Œåª½åª½åˆçµ¦ä»– ${b} é¡†ï¼Œå°æ˜ç¾åœ¨æœ‰å¹¾é¡†ç³–æœï¼Ÿ`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `æ¨¹ä¸Šæœ‰ ${a} éš»å°é³¥ï¼Œé£›èµ°äº† ${b} éš»ï¼Œé‚„å‰©ä¸‹å¹¾éš»å°é³¥ï¼Ÿ`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `ç±ƒå­è£¡æœ‰ ${a} é¡†è˜‹æœï¼Œå°è¯åƒæ‰ ${b} é¡†ï¼Œé‚„å‰©ä¸‹å¹¾é¡†è˜‹æœï¼Ÿ`,
                                a: a - b
                            }),
                            // --- åŠ æ³•æƒ…å¢ƒ (Addition) ---
                            (a, b) => ({
                                q: `æ›¸æ¶ä¸ŠåŸæœ¬æœ‰ ${a} æœ¬æ•…äº‹æ›¸ï¼Œçˆ¸çˆ¸åˆè²·äº† ${b} æœ¬çµ¦å°æ˜ï¼Œç¾åœ¨æ›¸æ¶ä¸Šå…±æœ‰å¹¾æœ¬æ›¸ï¼Ÿ`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `èŠ±åœ’è£¡é–‹äº† ${a} æœµç´…èŠ±ï¼Œæ—é‚Šé‚„æœ‰ ${b} æœµé»ƒèŠ±ï¼ŒèŠ±åœ’è£¡ç¸½å…±æœ‰å¹¾æœµèŠ±ï¼Ÿ`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `å°è±¬æ’²æ»¿è£¡æœ‰ ${a} å…ƒï¼Œå°ç¾ä»Šå¤©åˆå­˜é€²å» ${b} å…ƒï¼Œç¾åœ¨æ’²æ»¿è£¡æœ‰å¤šå°‘éŒ¢ï¼Ÿ`,
                                a: a + b
                            }),
                            (a, b) => ({
                                q: `åœè»Šå ´è£¡åœäº† ${a} è¼›ç´…è‰²æ±½è»Šå’Œ ${b} è¼›è—è‰²æ±½è»Šï¼Œåœè»Šå ´è£¡ç¸½å…±æœ‰å¹¾è¼›è»Šï¼Ÿ`,
                                a: a + b
                            }),

                            // --- æ¸›æ³•æƒ…å¢ƒ (Subtraction) ---
                            (a, b) => ({
                                q: `åœè»Šå ´åŸæœ¬æœ‰ ${a} è¼›è»Šï¼Œé–‹èµ°äº† ${b} è¼›ï¼Œç¾åœ¨åœè»Šå ´é‚„å‰©ä¸‹å¹¾è¼›è»Šï¼Ÿ`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `å†°ç®±è£¡æœ‰ ${a} é¡†é›è›‹ï¼Œåª½åª½åšè›‹ç³•ç”¨æ‰äº† ${b} é¡†ï¼Œå†°ç®±é‚„å‰©ä¸‹å¹¾é¡†é›è›‹ï¼Ÿ`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `å°ä¸‘æ‰‹ä¸Šæœ‰ ${a} å€‹æ°£çƒï¼Œä¸å°å¿ƒé£›èµ°äº† ${b} å€‹ï¼Œå°ä¸‘æ‰‹ä¸Šé‚„å‰©ä¸‹å¹¾å€‹æ°£çƒï¼Ÿ`,
                                a: a - b
                            }),
                            (a, b) => ({
                                q: `å…¬è»Šä¸ŠåŸæœ¬æœ‰ ${a} å€‹äººï¼Œåˆ°äº†è»Šç«™å¾Œä¸‹è»Šäº† ${b} å€‹äººï¼Œç¾åœ¨è»Šä¸Šé‚„æœ‰å¹¾å€‹äººï¼Ÿ`,
                                a: a - b
                            })
                        ];
                        const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                        const num1 = Math.floor(Math.random() * 15) + 5;
                        const num2 = Math.floor(Math.random() * num1) + 1;
                        const result = scenario(num1, num2);
                        return {
                            question: result.q,
                            answer: result.a,
                            options: generateOptions(result.a, 20)
                        };
                    } else {
                        const scenarios = [
                            () => {
                                // ç¢ºä¿ç­”æ¡ˆéè² ï¼šå…ˆæ±ºå®šå‰©é¤˜é‡‘é¡ï¼Œå†è¨ˆç®—ç¸½é‡‘é¡
                                const remaining = Math.floor(Math.random() * 15) + 5; // å‰©é¤˜5-19å…ƒ
                                const b = Math.floor(Math.random() * 15) + 5; // éºµåŒ…5-19å…ƒ
                                const c = Math.floor(Math.random() * 10) + 5; // é£²æ–™5-14å…ƒ
                                const a = remaining + b + c; // ç¸½é‡‘é¡ = å‰©é¤˜ + èŠ±è²»
                                return {
                                    q: `å°æ˜æœ‰ ${a} å…ƒï¼Œè²·äº†ä¸€å€‹ ${b} å…ƒçš„éºµåŒ…ï¼Œåˆè²·äº†ä¸€ç“¶ ${c} å…ƒçš„é£²æ–™ï¼Œé‚„å‰©ä¸‹å¤šå°‘å…ƒï¼Ÿ`,
                                    a: remaining
                                };
                            },
                            () => {
                                // ç¢ºä¿ç­”æ¡ˆéè² ï¼šå…ˆæ±ºå®šæœ€çµ‚æ›¸æœ¬æ•¸é‡ï¼Œå†è¨ˆç®—åˆå§‹æ•¸é‡
                                const finalBooks = Math.floor(Math.random() * 20) + 5; // æœ€çµ‚5-24æœ¬
                                const b = Math.floor(Math.random() * 10) + 3; // æ‹¿èµ°3-12æœ¬
                                const c = Math.floor(Math.random() * 15) + 5; // æ”¾ä¸Š5-19æœ¬
                                const a = finalBooks + b - c; // åˆå§‹æ•¸é‡ = æœ€çµ‚æ•¸é‡ + æ‹¿èµ° - æ”¾ä¸Š
                                // å¦‚æœåˆå§‹æ•¸é‡ä»å¯èƒ½ç‚ºè² ï¼Œå‰‡èª¿æ•´åƒæ•¸
                                if (a <= 0) {
                                    const adjustedA = Math.floor(Math.random() * 15) + 10; // é‡æ–°è¨­å®šåˆå§‹æ•¸é‡10-24æœ¬
                                    const adjustedB = Math.floor(Math.random() * (adjustedA - 5)) + 1; // æ‹¿èµ°æ•¸é‡ä¸è¶…éåˆå§‹æ•¸é‡-5
                                    const adjustedC = Math.floor(Math.random() * 10) + 5; // æ”¾ä¸Š5-14æœ¬
                                    return {
                                        q: `æ›¸æ¶ä¸Šæœ‰ ${adjustedA} æœ¬æ›¸ï¼Œå°è¯æ‹¿èµ° ${adjustedB} æœ¬ï¼Œåª½åª½åˆæ”¾ä¸Š ${adjustedC} æœ¬ï¼Œç¾åœ¨æœ‰å¹¾æœ¬æ›¸ï¼Ÿ`,
                                        a: adjustedA - adjustedB + adjustedC
                                    };
                                }
                                return {
                                    q: `æ›¸æ¶ä¸Šæœ‰ ${a} æœ¬æ›¸ï¼Œå°è¯æ‹¿èµ° ${b} æœ¬ï¼Œåª½åª½åˆæ”¾ä¸Š ${c} æœ¬ï¼Œç¾åœ¨æœ‰å¹¾æœ¬æ›¸ï¼Ÿ`,
                                    a: finalBooks
                                };
                            },
                            () => {
                                // æ–°å¢ä¸€å€‹è³¼ç‰©æ‰¾é›¶çš„æƒ…å¢ƒï¼Œç¢ºä¿ç­”æ¡ˆéè² 
                                const price = Math.floor(Math.random() * 30) + 20; // å•†å“20-49å…ƒ
                                const paid = Math.ceil(price / 10) * 10; // ä»˜æ¬¾é‡‘é¡ç‚ºpriceçš„ä¸Šå–æ•´åä½æ•¸
                                const change = paid - price;
                                return {
                                    q: `å°è¯è²·äº†ä¸€å€‹ ${price} å…ƒçš„ç©å…·ï¼Œä»˜äº† ${paid} å…ƒï¼Œæ‡‰è©²æ‰¾å›å¤šå°‘å…ƒï¼Ÿ`,
                                    a: change
                                };
                            },
                            // æ‚¨çš„åŸæœ‰é¡Œç›® 1: é€£çºŒæ¶ˆè²» (a - b - c)
                            () => {
                                const remaining = Math.floor(Math.random() * 15) + 5;
                                const b = Math.floor(Math.random() * 15) + 5;
                                const c = Math.floor(Math.random() * 10) + 5;
                                const a = remaining + b + c;
                                return {
                                    q: `å°æ˜æœ‰ ${a} å…ƒï¼Œè²·äº†ä¸€å€‹ ${b} å…ƒçš„éºµåŒ…ï¼Œåˆè²·äº†ä¸€ç“¶ ${c} å…ƒçš„é£²æ–™ï¼Œé‚„å‰©ä¸‹å¤šå°‘å…ƒï¼Ÿ`,
                                    a: remaining
                                };
                            },
                            // æ‚¨çš„åŸæœ‰é¡Œç›® 2: åŠ æ¸›æ··åˆ (a - b + c) æˆ–å€’æ¨
                            () => {
                                const finalBooks = Math.floor(Math.random() * 20) + 5;
                                const b = Math.floor(Math.random() * 10) + 3;
                                const c = Math.floor(Math.random() * 15) + 5;

                                // ç¢ºä¿ a > 0
                                const a = Math.max(finalBooks + b - c, 10); // ç¢ºä¿åˆå§‹æ•¸é‡è‡³å°‘ç‚º10
                                const actualFinal = a - b + c;

                                return {
                                    q: `æ›¸æ¶ä¸Šæœ‰ ${a} æœ¬æ›¸ï¼Œå°è¯æ‹¿èµ° ${b} æœ¬ï¼Œåª½åª½åˆæ”¾ä¸Š ${c} æœ¬ï¼Œç¾åœ¨æœ‰å¹¾æœ¬æ›¸ï¼Ÿ`,
                                    a: actualFinal
                                };
                            },
                            // æ‚¨çš„åŸæœ‰é¡Œç›® 3: è³¼ç‰©æ‰¾é›¶ (paid - price)
                            () => {
                                const price = Math.floor(Math.random() * 30) + 20;
                                const paid = Math.ceil(price / 10) * 10;
                                const change = paid - price;
                                return {
                                    q: `å°è¯è²·äº†ä¸€å€‹ ${price} å…ƒçš„ç©å…·ï¼Œä»˜äº† ${paid} å…ƒï¼Œæ‡‰è©²æ‰¾å›å¤šå°‘å…ƒï¼Ÿ`,
                                    a: change
                                };
                            },
                            // æ–°å¢é¡Œç›® 4: æ°£çƒèˆ‡é³¥é¡çš„åŠ æ¸›æ··åˆ (a - b + c)
                            () => {
                                const initial = Math.floor(Math.random() * 20) + 15;
                                const firstLoss = Math.floor(Math.random() * 8) + 2;
                                const secondGain = Math.floor(Math.random() * 10) + 5;
                                const finalAmount = initial - firstLoss + secondGain;

                                return {
                                    q: `å…¬åœ’è£¡åŸæœ¬æœ‰ ${initial} éš»é´¿å­ï¼Œé£›èµ°äº† ${firstLoss} éš»ï¼Œå¾Œä¾†åˆé£›ä¾†äº† ${secondGain} éš»ï¼Œç¾åœ¨å…¬åœ’è£¡é‚„æœ‰å¹¾éš»é´¿å­ï¼Ÿ`,
                                    a: finalAmount
                                };
                            },
                            // æ–°å¢é¡Œç›® 5: è”¬èœçš„é€£åŠ  (a + b + c)
                            () => {
                                const sectionA = Math.floor(Math.random() * 15) + 10;
                                const sectionB = Math.floor(Math.random() * 10) + 5;
                                const sectionC = Math.floor(Math.random() * 10) + 5;
                                const total = sectionA + sectionB + sectionC;

                                return {
                                    q: `è¾²å¤«åœ¨èœåœ’è£¡ç¨®äº† ${sectionA} æ ¹è˜¿è””ï¼Œ ${sectionB} æ¢åœ°ç“œï¼Œé‚„æœ‰ ${sectionC} æ ¹ç‰ç±³ï¼Œè¾²å¤«ç¸½å…±ç¨®äº†å¤šå°‘æ ¹ä½œç‰©ï¼Ÿ`,
                                    a: total
                                };
                            }
                        ];
                        const scenario = scenarios[Math.floor(Math.random() * scenarios.length)]();
                        return {
                            question: scenario.q,
                            answer: scenario.a,
                            options: generateOptions(scenario.a, 50)
                        };
                    }
                }
            },
            {
                id: 3,
                name: 'ä¹˜æ³•æ¢éšªå®¶',
                icon: 'âœ–ï¸',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2;
                    if (isEasy) {
                        const multipliers = [2, 3, 4, 5];
                        num1 = multipliers[Math.floor(Math.random() * multipliers.length)];
                        num2 = Math.floor(Math.random() * 9) + 1;
                    } else {
                        num1 = Math.floor(Math.random() * 9) + 1;
                        num2 = Math.floor(Math.random() * 9) + 1;
                    }
                    const answer = num1 * num2;
                    return {
                        question: `${num1} Ã— ${num2} = ?`,
                        answer: answer,
                        options: generateOptions(answer, isEasy ? 50 : 81)
                    };
                }
            },
            {
                id: 4,
                name: 'å¤§å°é­”ç‹æˆ°',
                icon: 'âš”ï¸',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2;
                    if (isEasy) {
                        num1 = Math.floor(Math.random() * 90) + 10;
                        num2 = Math.floor(Math.random() * 90) + 10;
                    } else {
                        num1 = Math.floor(Math.random() * 900) + 100;
                        num2 = Math.floor(Math.random() * 900) + 100;
                    }
                    let answer;
                    if (num1 > num2) answer = '>';
                    else if (num1 < num2) answer = '<';
                    else answer = '=';
                    return {
                        question: `${num1} _____ ${num2}`,
                        answer: answer,
                        options: ['<', '>', '='],
                        isComparison: true
                    };
                }
            },
            {
                id: 5,
                name: 'éŒ¢å¹£å¤§å¯Œç¿',
                icon: 'ğŸ’°',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    if (isEasy) {
                        const coins = [
                            { value: 1, count: Math.floor(Math.random() * 5) },
                            { value: 5, count: Math.floor(Math.random() * 4) },
                            { value: 10, count: Math.floor(Math.random() * 3) }
                        ];
                        const total = coins.reduce((sum, coin) => sum + coin.value * coin.count, 0);
                        const description = coins
                            .filter(c => c.count > 0)
                            .map(c => `${c.count} å€‹ ${c.value}å…ƒ`)
                            .join('ã€');
                        return {
                            question: `ä½ æœ‰ ${description}ï¼Œç¸½å…±æœ‰å¤šå°‘å…ƒï¼Ÿ`,
                            answer: total,
                            options: generateOptions(total, 50)
                        };
                    } else {
                        const coins = [
                            { value: 1, count: Math.floor(Math.random() * 5) },
                            { value: 5, count: Math.floor(Math.random() * 3) },
                            { value: 10, count: Math.floor(Math.random() * 3) },
                            { value: 50, count: Math.floor(Math.random() * 2) },
                            { value: 100, count: Math.floor(Math.random() * 2) }
                        ];
                        const total = coins.reduce((sum, coin) => sum + coin.value * coin.count, 0);
                        const description = coins
                            .filter(c => c.count > 0)
                            .map(c => `${c.count} å€‹ ${c.value}å…ƒ`)
                            .join('ã€');
                        return {
                            question: `ä½ æœ‰ ${description}ï¼Œç¸½å…±æœ‰å¤šå°‘å…ƒï¼Ÿ`,
                            answer: total,
                            options: generateOptions(total, 300)
                        };
                    }
                }
            },
            {
                id: 6,
                name: 'æ™‚é–“é­”æ³•é˜',
                icon: 'ğŸ•',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let hour, minute, answer;
                    if (isEasy) {
                        hour = Math.floor(Math.random() * 12) + 1;
                        minute = Math.random() > 0.5 ? 0 : 30;
                    } else {
                        hour = Math.floor(Math.random() * 12) + 1;
                        minute = Math.floor(Math.random() * 12) * 5;
                    }
                    const formatTime = (h, m) => `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    answer = formatTime(hour, minute);
                    return {
                        question: 'ç¾åœ¨æ˜¯å¹¾é»ï¼Ÿ',
                        answer: answer,
                        hour: hour,
                        minute: minute,
                        options: generateTimeOptions(hour, minute, isEasy),
                        isClock: true
                    };
                }
            }
        ];

        // ç¨ç«‹çš„ç·´ç¿’é—œå¡
        const PracticeLevels = [
            {
                id: 99,
                name: 'ä¹ä¹ä¹˜æ³•ç‹',
                icon: 'ğŸ”¢',
                generateQuestion: (difficulty) => {
                    const isEasy = difficulty === 'easy';
                    let num1, num2;

                    if (isEasy) {
                        // ç°¡å–®æ¨¡å¼ï¼š2-5çš„ä¹˜æ³•è¡¨
                        num1 = Math.floor(Math.random() * 4) + 2;
                        num2 = Math.floor(Math.random() * 8) + 2;
                    } else {
                        // å›°é›£æ¨¡å¼ï¼šå®Œæ•´ä¹ä¹ä¹˜æ³•è¡¨ 2-9
                        num1 = Math.floor(Math.random() * 8) + 2;
                        num2 = Math.floor(Math.random() * 8) + 2;
                    }

                    const answer = num1 * num2;

                    // ç”¢ç”Ÿæ›´å…·æŒ‘æˆ°æ€§çš„é¸é …
                    const generateMultiplicationOptions = (correct) => {
                        const options = [correct];
                        const possibleAnswers = [];

                        // ç”Ÿæˆç›¸è¿‘çš„ä¹˜æ³•çµæœä½œç‚ºå¹²æ“¾é¸é …
                        for (let i = 2; i <= 9; i++) {
                            for (let j = 2; j <= 9; j++) {
                                const result = i * j;
                                if (result !== correct && Math.abs(result - correct) <= 20) {
                                    possibleAnswers.push(result);
                                }
                            }
                        }

                        // éš¨æ©Ÿé¸æ“‡3å€‹ä¸é‡è¤‡çš„å¹²æ“¾é¸é …
                        while (options.length < 4 && possibleAnswers.length > 0) {
                            const randomIndex = Math.floor(Math.random() * possibleAnswers.length);
                            const option = possibleAnswers[randomIndex];
                            if (!options.includes(option)) {
                                options.push(option);
                            }
                            possibleAnswers.splice(randomIndex, 1);
                        }

                        // å¦‚æœé‚„ä¸å¤ 4å€‹é¸é …ï¼Œè£œå……ä¸€äº›ç›¸è¿‘æ•¸å­—
                        while (options.length < 4) {
                            const offset = Math.floor(Math.random() * 10) + 1;
                            const option = Math.random() > 0.5 ? correct + offset : correct - offset;
                            if (option > 0 && !options.includes(option)) {
                                options.push(option);
                            }
                        }

                        return shuffleArray(options);
                    };

                    return {
                        question: `${num1} Ã— ${num2} = ?`,
                        answer: answer,
                        options: generateMultiplicationOptions(answer)
                    };
                }
            }
        ];

        function generateOptions(correctAnswer, range) {
            const options = [correctAnswer];
            while (options.length < 4) {
                let option;
                if (typeof correctAnswer === 'number') {
                    const offset = Math.floor(Math.random() * 20) - 10;
                    option = correctAnswer + offset;
                    if (option < 0) option = Math.abs(option);
                    if (option > range) option = option % range;
                } else {
                    option = Math.floor(Math.random() * range);
                }
                if (!options.includes(option) && option >= 0) {
                    options.push(option);
                }
            }
            return shuffleArray(options);
        }

        function generateTimeOptions(hour, minute, isEasy) {
            const formatTime = (h, m) => `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            const correctAnswer = formatTime(hour, minute);
            const options = [correctAnswer];
            while (options.length < 4) {
                const h = Math.floor(Math.random() * 12) + 1;
                const m = isEasy
                    ? (Math.random() > 0.5 ? 0 : 30)
                    : Math.floor(Math.random() * 12) * 5;
                const option = formatTime(h, m);
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function drawClock(hour, minute) {
            const container = document.getElementById('clockContainer');
            let numbersHtml = '';
            for (let i = 1; i <= 12; i++) {
                const angleRad = (i * 30 - 90) * (Math.PI / 180);
                const radius = 40;
                const x = 50 + radius * Math.cos(angleRad);
                const y = 50 + radius * Math.sin(angleRad);
                numbersHtml += `<div class="clock-number" style="left: ${x}%; top: ${y}%">${i}</div>`;
            }
            container.innerHTML = `
                <div class="clock-display">
                    ${numbersHtml}
                    <div class="clock-center"></div>
                    <div class="clock-hand hour-hand" style="transform: rotate(${(hour % 12) * 30 + minute * 0.5}deg)"></div>
                    <div class="clock-hand minute-hand" style="transform: rotate(${minute * 6}deg)"></div>
                </div>
            `;
        }

        const Storage = {
            getRecord(levelId, difficulty) {
                const key = `level_${levelId}_${difficulty}`;
                return parseInt(localStorage.getItem(key)) || 0;
            },
            saveRecord(levelId, difficulty, stars) {
                const key = `level_${levelId}_${difficulty}`;
                const current = this.getRecord(levelId, difficulty);
                if (stars > current) {
                    localStorage.setItem(key, stars);
                }
            }
        };

        let gameState = {
            currentLevel: null,
            difficulty: null,
            questionIndex: 0,
            errors: 0,
            correctCount: 0,
            totalQuestions: 10,
            questions: []
        };

        function renderLevelMap() {
            // æ¸²æŸ“ä¸€èˆ¬é—œå¡
            const mapContainer = document.getElementById('levelMap');
            mapContainer.innerHTML = '';
            Levels.forEach(level => {
                const easyStars = Storage.getRecord(level.id, 'easy');
                const hardStars = Storage.getRecord(level.id, 'hard');
                const card = document.createElement('div');
                card.className = 'level-card';
                card.onclick = () => openDifficultyModal(level.id);
                card.innerHTML = `
                    <div class="level-icon">${level.icon}</div>
                    <h3>${level.name}</h3>
                    <div class="level-records">
                        <div class="record-item">
                            <div class="label">ç°¡å–®</div>
                            <div class="stars">${'â­'.repeat(easyStars)}${'â˜†'.repeat(3 - easyStars)}</div>
                        </div>
                        <div class="record-item">
                            <div class="label">å›°é›£</div>
                            <div class="stars">${'â­'.repeat(hardStars)}${'â˜†'.repeat(3 - hardStars)}</div>
                        </div>
                    </div>
                `;
                mapContainer.appendChild(card);
            });

            // æ¸²æŸ“ç·´ç¿’é—œå¡
            const practiceContainer = document.getElementById('practiceMap');
            practiceContainer.innerHTML = '';
            PracticeLevels.forEach(level => {
                const card = document.createElement('div');
                card.className = 'practice-card';
                card.onclick = () => openPracticeLevel(level.id);
                card.innerHTML = `
                    <div class="practice-icon">${level.icon}</div>
                    <h3>${level.name}</h3>
                    <div class="practice-description">
                        ç„¡é™ç·´ç¿’æ¨¡å¼<br>
                        ğŸ’ª æŒçºŒæŒ‘æˆ°ä¹ä¹ä¹˜æ³•è¡¨ ğŸ’ª<br>
                        <small>ç„¡éŒ¯èª¤é™åˆ¶ â€¢ ç„¡æ™‚é–“å£“åŠ›</small>
                    </div>
                `;
                practiceContainer.appendChild(card);
            });
        }

        function openDifficultyModal(levelId) {
            gameState.currentLevel = Levels.find(l => l.id === levelId);
            const modal = document.getElementById('difficultyModal');
            const title = document.getElementById('modalTitle');
            title.textContent = `${gameState.currentLevel.name} - é¸æ“‡é›£åº¦`;
            modal.classList.add('active');
        }

        function openPracticeLevel(levelId) {
            gameState.currentLevel = PracticeLevels.find(l => l.id === levelId);
            if (levelId === 99) { // ä¹ä¹ä¹˜æ³•ç‹
                startMultiplicationPractice();
            }
        }

        function closeModal() {
            document.getElementById('difficultyModal').classList.remove('active');
        }

        // ä¹ä¹ä¹˜æ³•ç‹å°ˆç”¨ç·´ç¿’æ¨¡å¼
        function startMultiplicationPractice() {
            gameState.difficulty = 'practice';
            gameState.questionIndex = 0;
            gameState.errors = 0;
            gameState.correctCount = 0;
            gameState.isPracticeMode = true;

            // éš±è—æ‰€æœ‰ä¸»é¸å–®å…ƒç´ ï¼ˆèˆ‡å…¶ä»–é—œå¡ä¸€è‡´ï¼‰
            document.getElementById('levelMap').style.display = 'none';
            document.querySelector('.practice-section').style.display = 'none';
            document.querySelector('.game-title').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');
            updatePracticeUI();
            generateNewMultiplicationQuestion();
        }

        function updatePracticeUI() {
            document.getElementById('levelName').textContent = gameState.currentLevel.name + ' - ç·´ç¿’æ¨¡å¼';
            document.getElementById('questionNumber').textContent = gameState.questionIndex + 1;
            document.getElementById('totalQuestions').textContent = 'âˆ';

            // éš±è—éŒ¯èª¤è¨ˆæ•¸å’Œé€²åº¦æ¢ï¼ˆç·´ç¿’æ¨¡å¼ä¸éœ€è¦ï¼‰
            document.getElementById('errorCount').parentElement.style.display = 'none';
            document.getElementById('progressFill').parentElement.style.display = 'none';
        }

        function generateNewMultiplicationQuestion() {
            // éš¨æ©Ÿé¸æ“‡ 2-9 çš„ä¹˜æ³•è¡¨
            const num1 = Math.floor(Math.random() * 8) + 2;
            const num2 = Math.floor(Math.random() * 8) + 2;
            const answer = num1 * num2;

            const generateMultiplicationOptions = (correct) => {
                const options = [correct];
                const possibleAnswers = [];

                // ç”Ÿæˆç›¸è¿‘çš„ä¹˜æ³•çµæœä½œç‚ºå¹²æ“¾é¸é …
                for (let i = 2; i <= 9; i++) {
                    for (let j = 2; j <= 9; j++) {
                        const result = i * j;
                        if (result !== correct && Math.abs(result - correct) <= 20) {
                            possibleAnswers.push(result);
                        }
                    }
                }

                // éš¨æ©Ÿé¸æ“‡3å€‹ä¸é‡è¤‡çš„å¹²æ“¾é¸é …
                while (options.length < 4 && possibleAnswers.length > 0) {
                    const randomIndex = Math.floor(Math.random() * possibleAnswers.length);
                    const option = possibleAnswers[randomIndex];
                    if (!options.includes(option)) {
                        options.push(option);
                    }
                    possibleAnswers.splice(randomIndex, 1);
                }

                // å¦‚æœé‚„ä¸å¤ 4å€‹é¸é …ï¼Œè£œå……ä¸€äº›ç›¸è¿‘æ•¸å­—
                while (options.length < 4) {
                    const offset = Math.floor(Math.random() * 10) + 1;
                    const option = Math.random() > 0.5 ? correct + offset : correct - offset;
                    if (option > 0 && !options.includes(option)) {
                        options.push(option);
                    }
                }

                return shuffleArray(options);
            };

            const currentQuestion = {
                question: `${num1} Ã— ${num2} = ?`,
                answer: answer,
                options: generateMultiplicationOptions(answer)
            };

            showPracticeQuestion(currentQuestion);
        }

        function showPracticeQuestion(question) {
            const questionContent = document.getElementById('questionContent');
            const answersContainer = document.getElementById('answersContainer');
            const clockContainer = document.getElementById('clockContainer');

            questionContent.textContent = question.question;
            clockContainer.innerHTML = '';
            answersContainer.innerHTML = '';

            question.options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = option;
                btn.onclick = () => checkPracticeAnswer(option, btn, question.answer);
                answersContainer.appendChild(btn);
            });
        }

        function checkPracticeAnswer(selected, btnElement, correctAnswer) {
            const isCorrect = selected === correctAnswer;

            // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
            });

            if (isCorrect) {
                btnElement.classList.add('correct');
                AudioSystem.playCorrect();
                gameState.correctCount++;
                gameState.questionIndex++;

                // 1ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ
                setTimeout(() => {
                    updatePracticeUI();
                    generateNewMultiplicationQuestion();
                }, 1000);
            } else {
                btnElement.classList.add('wrong');
                AudioSystem.playWrong();

                // é«˜äº®é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    if (btn.textContent === String(correctAnswer)) {
                        btn.classList.add('correct');
                    }
                });

                // 2ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œï¼ˆçµ¦æ›´å¤šæ™‚é–“æŸ¥çœ‹æ­£ç¢ºç­”æ¡ˆï¼‰
                setTimeout(() => {
                    gameState.questionIndex++;
                    updatePracticeUI();
                    generateNewMultiplicationQuestion();
                }, 2000);
            }
        }

        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            gameState.questionIndex = 0;
            gameState.errors = 0;
            gameState.correctCount = 0;
            gameState.questions = [];
            for (let i = 0; i < gameState.totalQuestions; i++) {
                gameState.questions.push(gameState.currentLevel.generateQuestion(difficulty));
            }
            closeModal();

            // éš±è—æ‰€æœ‰ä¸»é¸å–®å…ƒç´ 
            document.getElementById('levelMap').style.display = 'none';
            document.querySelector('.practice-section').style.display = 'none';
            document.querySelector('.game-title').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');
            updateGameUI();
            showQuestion();
        }

        function updateGameUI() {
            document.getElementById('levelName').textContent = gameState.currentLevel.name;
            document.getElementById('questionNumber').textContent = gameState.questionIndex + 1;
            document.getElementById('totalQuestions').textContent = gameState.totalQuestions;
            document.getElementById('errorCount').textContent = gameState.errors;
            const progress = ((gameState.questionIndex) / gameState.totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showQuestion() {
            const question = gameState.questions[gameState.questionIndex];
            const questionContent = document.getElementById('questionContent');
            const answersContainer = document.getElementById('answersContainer');
            const clockContainer = document.getElementById('clockContainer');
            questionContent.textContent = question.question;
            clockContainer.innerHTML = '';
            if (question.isClock) {
                drawClock(question.hour, question.minute);
            }
            answersContainer.innerHTML = '';
            question.options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option, btn);
                answersContainer.appendChild(btn);
            });
        }

        function checkAnswer(selected, btnElement) {
            const question = gameState.questions[gameState.questionIndex];
            const isCorrect = selected === question.answer;
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
            });
            if (isCorrect) {
                btnElement.classList.add('correct');
                AudioSystem.playCorrect();
                gameState.correctCount++;
                setTimeout(() => {
                    gameState.questionIndex++;
                    if (gameState.questionIndex >= gameState.totalQuestions) {
                        endGame();
                    } else {
                        updateGameUI();
                        showQuestion();
                    }
                }, 1000);
            } else {
                btnElement.classList.add('wrong');
                AudioSystem.playWrong();
                gameState.errors++;
                document.getElementById('errorCount').textContent = gameState.errors;

                // Highlight the correct answer
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    if (btn.textContent === String(question.answer)) {
                        btn.classList.add('correct');
                    }
                });

                if (gameState.errors >= 3) {
                    setTimeout(() => {
                        endGame();
                    }, 1000);
                } else {
                    setTimeout(() => {
                        gameState.questionIndex++;
                        if (gameState.questionIndex >= gameState.totalQuestions) {
                            endGame();
                        } else {
                            updateGameUI();
                            showQuestion();
                        }
                    }, 1000);
                }
            }
        }

        function endGame() {
            const correctAnswers = gameState.correctCount;
            let stars = 0;
            if (gameState.errors === 0) stars = 3;
            else if (gameState.errors === 1) stars = 2;
            else if (gameState.errors === 2) stars = 1;
            Storage.saveRecord(gameState.currentLevel.id, gameState.difficulty, stars);
            document.getElementById('gameScreen').classList.remove('active');
            const resultScreen = document.getElementById('resultScreen');
            resultScreen.classList.add('active');
            const resultTitle = document.getElementById('resultTitle');
            const resultStars = document.getElementById('resultStars');
            const resultMessage = document.getElementById('resultMessage');
            if (stars === 3) {
                resultTitle.textContent = 'å¤ªæ£’äº†ï¼å®Œç¾éé—œï¼';
                resultMessage.textContent = `ä½ ç­”å°äº†å…¨éƒ¨ ${gameState.totalQuestions} é¡Œï¼`;
                AudioSystem.playComplete();
            } else if (stars > 0) {
                resultTitle.textContent = 'åšå¾—å¥½ï¼';
                resultMessage.textContent = `ä½ ç­”å°äº† ${correctAnswers} é¡Œï¼Œç¹¼çºŒåŠ æ²¹ï¼`;
                AudioSystem.playComplete();
            } else {
                resultTitle.textContent = 'å†æ¥å†å²ï¼';
                resultMessage.textContent = `é€™æ¬¡ç­”å°äº† ${correctAnswers} é¡Œï¼Œä¸‹æ¬¡ä¸€å®šæœƒæ›´å¥½ï¼`;
            }
            resultStars.textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(3 - stars);
        }

        function exitGame() {
            if (confirm('ç¢ºå®šè¦é›¢é–‹éŠæˆ²å—ï¼Ÿé€²åº¦å°‡ä¸æœƒä¿å­˜ã€‚')) {
                backToMap();
            }
        }

        function retryLevel() {
            document.getElementById('resultScreen').classList.remove('active');
            startGame(gameState.difficulty);
        }

        function backToMap() {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('resultScreen').classList.remove('active');
            document.getElementById('levelMap').style.display = 'grid';
            renderLevelMap();
            document.querySelector('.practice-section').style.display = 'block';
            document.querySelector('.game-title').style.display = 'block';
        }

        window.onload = () => {
            AudioSystem.init();
            renderLevelMap();
        };
    </script>
</body>

</html>